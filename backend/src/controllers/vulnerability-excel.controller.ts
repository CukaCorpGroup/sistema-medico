import { Request, Response } from 'express';
import excelDB from '../utils/excel-database';
import logger from '../utils/logger';

export const searchVulnerabilities = async (req: Request, res: Response) => {
  try {
    const { query = '' } = req.query;

    if (!query || (query as string).length < 2) {
      return res.json({
        success: true,
        data: [],
        message: 'Ingrese al menos 2 caracteres para buscar',
      });
    }

    logger.info(`Buscando vulnerabilidades: ${query}`);

    const vulnerabilities = await excelDB.searchVulnerabilities(query as string);

    res.json({
      success: true,
      data: vulnerabilities,
    });
  } catch (error: any) {
    logger.error('Error al buscar vulnerabilidades:', error);
    res.status(500).json({
      success: false,
      message: 'Error al buscar vulnerabilidades',
      error: error.message,
    });
  }
};

export const getAllVulnerabilities = async (req: Request, res: Response) => {
  try {
    const vulnerabilities = await excelDB.getVulnerabilities();

    res.json({
      success: true,
      data: vulnerabilities.filter(v => v.isActive),
    });
  } catch (error: any) {
    logger.error('Error al obtener vulnerabilidades:', error);
    res.status(500).json({
      success: false,
      message: 'Error al obtener vulnerabilidades',
      error: error.message,
    });
  }
};

export const createVulnerability = async (req: Request, res: Response) => {
  try {
    const { code, description, category, isActive = true } = req.body;

    if (!code || !description) {
      return res.status(400).json({
        success: false,
        message: 'Código y descripción son requeridos',
      });
    }

    const newVulnerability = await excelDB.createVulnerability({
      code,
      description,
      category,
      isActive,
    });

    res.status(201).json({
      success: true,
      data: newVulnerability,
    });
  } catch (error: any) {
    logger.error('Error al crear vulnerabilidad:', error);
    res.status(500).json({
      success: false,
      message: 'Error al crear vulnerabilidad',
      error: error.message,
    });
  }
};



